<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Deep Dive - Microsoft Agent Framework Workshop</title>
    <link rel="stylesheet" href="assets/styles.css">
    <script src="assets/copy-code.js" defer></script>
    <script src="assets/menu.js" defer></script>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <h1>ü§ñ Microsoft Agent Framework</h1>
            <p>Hands-on Workshop</p>
        </div>
        <ul class="nav-menu">
            <li class="nav-item"><a href="index.html" class="nav-link">Introduction</a></li>
            
            <!-- Beginners Section -->
            <li class="nav-section">
                <div class="nav-section-header" data-section="beginners">üë®‚Äçüéì BEGINNERS</div>
                <ul class="nav-section-content collapsed">
                    <li class="nav-item"><a href="beginner-start.html" class="nav-link"><span class="step-number">‚òÖ</span>Getting Started</a></li>
                    <li class="nav-item"><a href="environment-setup.html" class="nav-link"><span class="step-number">1</span>Codespaces Setup</a></li>
                    <li class="nav-item"><a href="azure-setup.html" class="nav-link"><span class="step-number">2</span>Azure OpenAI Setup</a></li>
                    <li class="nav-item"><a href="code-walkthrough.html" class="nav-link"><span class="step-number">3</span>Code Walkthrough</a></li>
                    <li class="nav-item"><a href="running-app.html" class="nav-link"><span class="step-number">4</span>Running the Agent</a></li>
                    <li class="nav-item"><a href="troubleshooting.html" class="nav-link"><span class="step-number">5</span>Troubleshooting</a></li>
                </ul>
            </li>

            <!-- Advanced Section -->
            <li class="nav-section">
                <div class="nav-section-header" data-section="advanced">üöÄ ADVANCED</div>
                <ul class="nav-section-content">
                    <li class="nav-item"><a href="advanced-start.html" class="nav-link"><span class="step-number">‚òÖ</span>Getting Started</a></li>
                    <li class="nav-item"><a href="advanced-architecture.html" class="nav-link"><span class="step-number">1</span>Architecture Overview</a></li>
                    <li class="nav-item"><a href="advanced-setup.html" class="nav-link"><span class="step-number">2</span>Environment Setup</a></li>
                    <li class="nav-item"><a href="advanced-walkthrough.html" class="nav-link active"><span class="step-number">3</span>Code Deep Dive</a></li>
                    <li class="nav-item"><a href="advanced-running.html" class="nav-link"><span class="step-number">4</span>Running the App</a></li>
                    <li class="nav-item"><a href="advanced-troubleshooting.html" class="nav-link"><span class="step-number">5</span>Troubleshooting</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Module 3: Code Deep Dive</h1>
            <p class="page-subtitle">Understanding the multi-agent orchestrator implementation</p>
            <span class="duration-badge">‚è±Ô∏è Duration: 25 minutes</span>
        </div>

        <section class="content-section">
            <h2 class="section-title">üîç Understanding agentApp.py</h2>
            <p>The heart of our system is <code>agentApp.py</code>. Let's understand its key functions and classes:</p>

            <h3 class="code-block-header">Terminal Command</h3>
            <div class="code-block">
                <pre><code>code agentApp.py</code></pre>
            </div>

            <h3 class="section-subtitle">üì¶ Key Dependencies</h3>
            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <ul style="margin-left: 20px; font-size: 0.95rem; line-height: 1.8;">
                    <li><strong>FastAPI:</strong> Web framework for building REST APIs</li>
                    <li><strong>asyncio:</strong> Enables concurrent execution of multiple agents</li>
                    <li><strong>ChatCompletionsClient:</strong> Azure OpenAI SDK for GPT model access</li>
                    <li><strong>BBCNewsAgent & TechCrunchAgent:</strong> Custom agents for news scraping</li>
                </ul>
            </div>

            <h3 class="section-subtitle">üéØ Class: AgentOrchestrator</h3>
            <p>The main class that coordinates multiple agents.</p>

            <div style="background: #e9f5e9; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1d8102;">
                <h4>üìå <code>__init__(self)</code></h4>
                <p><strong>Purpose:</strong> Initializes the orchestrator with Azure OpenAI credentials.</p>
                <p><strong>Key Operations:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Loads environment variables from <code>.env</code> file</li>
                    <li>Reads Azure OpenAI endpoint, API key, and deployment name</li>
                    <li>Creates <code>ChatCompletionsClient</code> for GPT communication</li>
                    <li>Sets up logging for debugging and monitoring</li>
                </ul>
                <p><strong>Important Code:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><code>load_dotenv()</code> - Loads credentials securely from .env file</li>
                    <li><code>ChatCompletionsClient(endpoint, credential)</code> - Authenticates with Azure</li>
                </ul>
            </div>

            <div style="background: #e7f2fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #146eb4;">
                <h4>üìå <code>async def fetch_all_news(query)</code></h4>
                <p><strong>Purpose:</strong> Orchestrates multiple agents to fetch news concurrently.</p>
                <p><strong>Key Operations:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Creates BBC and TechCrunch agent instances with specific instructions</li>
                    <li><strong>Fan-Out:</strong> Dispatches both agents to run in parallel</li>
                    <li>Waits for all agents to complete using <code>asyncio.gather()</code></li>
                    <li><strong>Fan-In:</strong> Aggregates results from both agents</li>
                    <li>Returns combined results with timestamp and status</li>
                </ul>
                <p><strong>Important Code:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><code>asyncio.gather(bbc_task, tech_task)</code> - Runs agents concurrently (not sequentially)</li>
                    <li>Error handling ensures partial results are returned even if one agent fails</li>
                </ul>
            </div>

            <h3 class="section-subtitle">üåê FastAPI Endpoints</h3>
            
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9900;">
                <h4>üìå <code>@app.get("/")</code> - read_root()</h4>
                <p><strong>Purpose:</strong> Serves the main web interface HTML file.</p>
                <p><strong>Returns:</strong> <code>static/index.html</code> - the dashboard UI</p>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9900;">
                <h4>üìå <code>@app.post("/api/fetch-news")</code> - fetch_news()</h4>
                <p><strong>Purpose:</strong> Main API endpoint that triggers the multi-agent orchestration.</p>
                <p><strong>Key Operations:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Accepts optional JSON body with custom query parameter</li>
                    <li>Calls <code>orchestrator.fetch_all_news()</code> to execute agents</li>
                    <li>Returns JSON response with news from both sources</li>
                    <li>Handles errors gracefully with 500 status code</li>
                </ul>
                <p><strong>Important Code:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><code>await orchestrator.fetch_all_news(query)</code> - Async call enables non-blocking execution</li>
                    <li><code>JSONResponse(content=result)</code> - Returns structured data to frontend</li>
                </ul>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9900;">
                <h4>üìå <code>@app.get("/health")</code> - health_check()</h4>
                <p><strong>Purpose:</strong> Health check endpoint for monitoring service status.</p>
                <p><strong>Returns:</strong> Simple JSON confirming service is running</p>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <strong>Concurrency Insight:</strong> The <code>asyncio.gather()</code> call is the key to parallel execution. It starts both agents simultaneously, making the system ~2x faster than sequential execution.
            </div>
        </section>

        <section class="content-section">
            <h2 class="section-title">üõ†Ô∏è Understanding BBCNewsAgent (bbc_news_agent.py)</h2>
            <p>Let's break down the BBC news scraping agent function by function.</p>

            <h3 class="code-block-header">Terminal Command</h3>
            <div class="code-block">
                <pre><code>code tools/bbc_news_agent.py</code></pre>
            </div>

            <h3 class="section-subtitle">üéØ Class: BBCNewsAgent</h3>
            <p>Inherits from <code>BaseAgent</code> - an abstract class providing common agent functionality.</p>

            <div style="background: #e9f5e9; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1d8102;">
                <h4>üìå <code>async def execute(query)</code></h4>
                <p><strong>Purpose:</strong> Main entry point that orchestrates the news fetching workflow.</p>
                <p><strong>Key Operations:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Calls <code>_scrape_bbc_news()</code> to fetch raw headlines from BBC website</li>
                    <li>Validates that articles were found (error handling)</li>
                    <li>Calls <code>_process_with_ai()</code> to enhance headlines with AI-generated summaries</li>
                    <li>Returns structured JSON with articles, source name, and count</li>
                </ul>
                <p><strong>Important Code:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><code>await self._scrape_bbc_news()</code> - Async call ensures non-blocking web scraping</li>
                    <li>Exception handling returns empty array with error details (graceful degradation)</li>
                </ul>
            </div>

            <div style="background: #e7f2fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #146eb4;">
                <h4>üìå <code>async def _scrape_bbc_news()</code></h4>
                <p><strong>Purpose:</strong> Fetches and parses BBC homepage to extract news headlines.</p>
                <p><strong>Key Operations:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Uses <code>aiohttp</code> for async HTTP requests (non-blocking)</li>
                    <li>Sets User-Agent header to mimic browser requests (required for scraping)</li>
                    <li>Parses HTML with BeautifulSoup to extract headline elements</li>
                    <li>Filters out short/empty titles to ensure quality</li>
                    <li>Returns top 10 articles with title, URL, and empty summary</li>
                </ul>
                <p><strong>Important Code:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><code>async with aiohttp.ClientSession()</code> - Context manager for efficient connection pooling</li>
                    <li><code>soup.find_all(['h2', 'h3'], class_=lambda x: ...)</code> - Flexible CSS selector for BBC's HTML structure</li>
                    <li><code>timeout=10</code> - Prevents hanging requests from blocking other agents</li>
                </ul>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9900;">
                <h4>üìå <code>async def _process_with_ai(articles, query)</code></h4>
                <p><strong>Purpose:</strong> Enhances raw headlines with AI-generated summaries using Azure OpenAI.</p>
                <p><strong>Key Operations:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Formats articles into a prompt for GPT model</li>
                    <li>Calls Azure OpenAI to generate compelling 2-3 sentence summaries</li>
                    <li>Parses AI response and merges with original URLs</li>
                    <li>Falls back to original articles if AI processing fails</li>
                </ul>
                <p><strong>Important Code:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li><code>await self.client.complete(model=self.model, messages=[...])</code> - Async GPT call enables parallel AI processing</li>
                    <li>Prompt engineering: Instructs AI to keep title, add summary, focus on important aspects</li>
                    <li>Fallback mechanism ensures partial success even if AI fails</li>
                </ul>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <strong>Agent Pattern:</strong> This two-step pattern (scrape ‚Üí enhance with AI) separates data collection from intelligent processing, making the code modular and testable.
            </div>
            </div>
        </section>

        <section class="content-section">
            <h2 class="section-title">üåê Frontend Integration</h2>
            <p>Let's examine how the web interface communicates with our FastAPI backend.</p>

            <h3 class="section-subtitle">JavaScript API Communication</h3>
            <h3 class="code-block-header">Terminal Command</h3>
            <div class="code-block">
                <pre><code>code static/script.js</code></pre>
            </div>

            <div class="code-block">
                <pre><code>// Main function to fetch news from our multi-agent API
async function fetchNews() {
    const loadingIndicator = document.getElementById('loading');
    const newsContainer = document.getElementById('news-container');
    const fetchButton = document.getElementById('fetch-news-btn');
    
    // Show loading state
    loadingIndicator.style.display = 'block';
    fetchButton.disabled = true;
    fetchButton.textContent = 'Fetching News...';
    newsContainer.innerHTML = '';
    
    try {
        // Call our FastAPI endpoint
        const response = await fetch('/api/fetch-news', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: 'latest news'
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Handle successful response
        if (data.status === 'success') {
            displayNews(data);
        } else {
            displayError(data.error || 'Unknown error occurred');
        }
        
    } catch (error) {
        console.error('Error fetching news:', error);
        displayError('Failed to fetch news. Please try again.');
    } finally {
        // Reset button state
        loadingIndicator.style.display = 'none';
        fetchButton.disabled = false;
        fetchButton.textContent = 'Fetch Latest News';
    }
}

// Display news from both agents
function displayNews(data) {
    const newsContainer = document.getElementById('news-container');
    
    // Create sections for BBC and TechCrunch news
    if (data.bbc_news && data.bbc_news.articles) {
        createNewsSection('BBC News', data.bbc_news.articles, '#1d8102');
    }
    
    if (data.tech_news && data.tech_news.articles) {
        createNewsSection('Technology News', data.tech_news.articles, '#ff9900');
    }
}

function createNewsSection(title, articles, color) {
    const newsContainer = document.getElementById('news-container');
    
    const section = document.createElement('div');
    section.className = 'news-section';
    
    const sectionTitle = document.createElement('h2');
    sectionTitle.textContent = title;
    sectionTitle.style.color = color;
    section.appendChild(sectionTitle);
    
    articles.forEach(article => {
        const articleCard = document.createElement('div');
        articleCard.className = 'news-card';
        articleCard.innerHTML = `
            <h3><a href="${article.url}" target="_blank">${article.title}</a></h3>
            <p>${article.summary || 'No summary available'}</p>
        `;
        section.appendChild(articleCard);
    });
    
    newsContainer.appendChild(section);
}</code></pre>
            </div>

            <h2 class="section-title" style="margin-top: 50px;">üõ†Ô∏è Understanding TechCrunchAgent (techcrunch_agent.py)</h2>
            <p>The TechCrunch agent follows the exact same pattern as BBC agent but targets tech news.</p>

            <h3 class="code-block-header">Terminal Command</h3>
            <div class="code-block">
                <pre><code>code tools/techcrunch_agent.py</code></pre>
            </div>

            <h3 class="section-subtitle">üéØ Class: TechCrunchAgent</h3>
            <p>Implements the same interface as BBCNewsAgent but adapted for TechCrunch's website structure.</p>

            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9900;">
                <h4>üìå <code>async def execute(query)</code></h4>
                <p><strong>Purpose:</strong> Main workflow orchestrator (same pattern as BBC agent).</p>
                <p><strong>Key Operations:</strong> Scrape ‚Üí Validate ‚Üí AI enhance ‚Üí Return structured results</p>
            </div>

            <div style="background: #e7f2fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #146eb4;">
                <h4>üìå <code>async def _scrape_techcrunch_news()</code></h4>
                <p><strong>Purpose:</strong> Fetches and parses TechCrunch homepage for tech headlines.</p>
                <p><strong>Key Differences from BBC:</strong></p>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>Targets <code>https://techcrunch.com/</code> instead of BBC</li>
                    <li>Uses different CSS selectors specific to TechCrunch's HTML structure</li>
                    <li>Looks for <code>&lt;article&gt;</code> tags and different class names</li>
                    <li>Same async HTTP pattern with aiohttp and BeautifulSoup</li>
                </ul>
            </div>

            <div style="background: #e9f5e9; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1d8102;">
                <h4>üìå <code>async def _process_with_ai(articles, query)</code></h4>
                <p><strong>Purpose:</strong> Enhances tech headlines with AI summaries.</p>
                <p><strong>Key Details:</strong> Uses same Azure OpenAI pattern but with tech-focused prompts (e.g., "focus on innovation, startups, and emerging technologies")</p>
            </div>

            <div class="alert alert-info">
                <span class="alert-icon">‚ÑπÔ∏è</span>
                <strong>Reusable Pattern:</strong> The beauty of the BaseAgent abstraction is that you can add more agents (e.g., Reddit, Hacker News) by simply implementing <code>execute()</code> and scraping methods specific to those sites.
            </div>
        </section>

        <section class="content-section">
            <h2 class="section-title">üîÑ Execution Flow Summary</h2>
            <p>Here's how everything works together when a user clicks "Fetch News":</p>

            <div style="background: #f9f9f9; padding: 30px; border-radius: 12px; margin: 20px 0;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #667eea; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</div>
                        <div>
                            <strong>User clicks "Fetch News"</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">JavaScript sends POST request to /api/fetch-news</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #ff9900; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</div>
                        <div>
                            <strong>FastAPI receives request</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">AgentOrchestrator.fetch_all_news() is called</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #1d8102; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</div>
                        <div>
                            <strong>Fan-Out: Agents dispatched</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">BBC and TechCrunch agents start concurrently via asyncio.gather()</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #d13212; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">4</div>
                        <div>
                            <strong>Parallel web scraping</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">Both agents scrape their respective websites simultaneously</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #0078d4; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">5</div>
                        <div>
                            <strong>AI processing</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">Azure OpenAI enhances headlines with summaries</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #6f42c1; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">6</div>
                        <div>
                            <strong>Fan-In: Results aggregated</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">Orchestrator combines both agents' results into single response</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="background: #198754; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold;">7</div>
                        <div>
                            <strong>UI updates</strong><br>
                            <span style="font-size: 0.9rem; color: #666;">JavaScript renders news cards for both BBC and TechCrunch</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-success">
                <span class="alert-icon">‚úÖ</span>
                <strong>Performance Benefit:</strong> Thanks to the Fan-Out/Fan-In pattern, steps 3-5 happen in parallel, making the system approximately 2x faster than sequential execution.
            </div>
        </section>

        <section class="content-section">
            <h2 class="section-title">üéØ Key Takeaways</h2>
            <p>Now you understand the core implementation patterns:</p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">
                <div style="padding: 20px; background: #e9f5e9; border-radius: 8px; border-left: 4px solid #1d8102;">
                    <h4>üèóÔ∏è Modular Architecture</h4>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Base agent class ensures consistent interfaces, while specialized agents handle specific data sources.</p>
                </div>
                <div style="padding: 20px; background: #e7f2fa; border-radius: 8px; border-left: 4px solid #146eb4;">
                    <h4>‚ö° Async/Concurrent</h4>
                    <p style="font-size: 0.9rem; margin-top: 10px;">asyncio.gather() enables true parallel execution of multiple agents, improving performance significantly.</p>
                </div>
                <div style="padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9900;">
                    <h4>ü§ñ AI-Enhanced</h4>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Azure OpenAI transforms raw scraped data into engaging, summarized content.</p>
                </div>
                <div style="padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #d13212;">
                    <h4>üåê Web-Native</h4>
                    <p style="font-size: 0.9rem; margin-top: 10px;">FastAPI provides modern REST API with automatic documentation and async support.</p>
                </div>
            </div>

            <p>In the next module, we'll run the application and see all these components working together in real-time.</p>
        </section>

        <div class="page-navigation">
            <a href="advanced-setup.html" class="nav-button secondary">‚Üê Environment Setup</a>
            <a href="advanced-running.html" class="nav-button">Next: Running the App ‚Üí</a>
        </div>
    </main>
</body>
</html>